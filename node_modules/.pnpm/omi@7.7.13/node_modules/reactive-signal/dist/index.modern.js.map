{"version":3,"file":"index.modern.js","sources":["../src/reactivity.ts"],"sourcesContent":["type Subscriber = () => void;\n\nlet activeEffect: Effect | null = null;\nlet isBatching = false;\nlet pendingSubscribers: Set<Subscriber> = new Set();\n\nexport interface Component {\n  queuedUpdate: () => void\n  [key: string]: any\n  _tempActiveUpdateFnName?: string\n}\n\nlet activeComponent: Component | null = null\n\nexport function setActiveComponent(\n  component: Component,\n  updateFnName?: string,\n): void {\n  activeComponent = component\n  activeComponent._tempActiveUpdateFnName = updateFnName || 'queuedUpdate'\n}\n\nexport function clearActiveComponent(): void {\n  activeComponent = null\n}\n\nexport function getActiveComponent(): Component | null {\n  return activeComponent\n}\n\n\nexport class Signal<T> {\n  private _value: T;\n  private subscribers: Set<Subscriber> = new Set();\n  depsComponents = new Set<Component>()\n  constructor(value: T) {\n    this._value = value;\n  }\n\n  get value(): T {\n    // 没有在通知，才能添加依赖，否则会导致循环依赖\n    if (!this.notifying) {\n      if (activeEffect) {\n        // computed 内部触发的原始信号的 get value 不用加入原始信号的订阅\n        if (activeEffect.run) {\n          this.subscribe(activeEffect.run);\n        }\n        activeEffect.addDependency(this);\n      }\n    }\n\n    const component = getActiveComponent()\n    if (component) this.depsComponents.add(component)\n    return this._value;\n  }\n\n  set value(newValue: T) {\n    // 修改前也有 hook？\n    if (newValue !== this._value) {\n      this._value = newValue;\n      this.update();\n    }\n  }\n\n  peek() {\n    return this._value;\n  }\n\n  update() {\n    this.notify();\n    this.depsComponents.forEach(\n      (component) => component[component._tempActiveUpdateFnName!]?.(),\n    )\n    // 信号值修改后 hook，重置已经执行的 effect\n    this.subscribers.forEach(callback => {\n      // 重置计算属性的 subscribers，防止不依赖 signal 但依赖 computed的 effect不执行\n      // @ts-ignore\n      if (callback.computedInstance) {\n        // @ts-ignore\n        callback.computedInstance.subscribers.forEach(callback => {\n          callback.done = false;\n        });\n      }\n      // @ts-ignore\n      callback.done = false;\n    });\n  }\n\n  subscribe(callback: Subscriber) {\n    this.subscribers.add(callback);\n  }\n\n  unsubscribe(callback: Subscriber) {\n    this.subscribers.delete(callback);\n  }\n\n  private notifying = false;\n  private notify() {\n    if (isBatching) {\n      this.subscribers.forEach(callback => pendingSubscribers.add(callback));\n    } else {\n      this.notifying = true;\n      this.subscribers.forEach(callback => {\n        // @ts-ignore\n        if (typeof callback === 'function' && !callback.done) {\n          // @ts-ignore\n          callback.done = true;\n          callback();\n        }\n      });\n      this.notifying = false;\n    }\n  }\n}\n\nexport class Computed<T> {\n  private computeFn: () => T;\n  private _value: T;\n  private dependencies: Set<Signal<any> | Computed<any>> = new Set();\n  private subscribers: Set<Subscriber> = new Set();\n\n  depsComponents = new Set<Component>()\n\n  constructor(computeFn: () => T) {\n    this.computeFn = computeFn;\n    this._value = this.compute();\n  }\n\n  get value(): T {\n    if (!this.notifying) {\n      if (activeEffect) {\n        this.subscribe(activeEffect.run);\n        activeEffect.addDependency(this);\n      }\n    }\n    const component = getActiveComponent()\n    if (component) this.depsComponents.add(component)\n    return this._value;\n  }\n\n  peek() {\n    return this._value;\n  }\n\n  private notifying = false;\n  private compute(): T {\n\n    const previousEffect = activeEffect;\n    // @ts-ignore\n    activeEffect = this;\n    const newValue = this.computeFn();\n    activeEffect = previousEffect;\n\n    return newValue;\n  }\n\n  private recompute = () => {\n    const newValue = this.compute();\n    if (newValue !== this._value) {\n      this._value = newValue;\n      this.notify();\n      this.depsComponents.forEach(\n        (component) => component[component._tempActiveUpdateFnName!]?.(),\n      )\n    }\n  }\n\n  subscribe(callback: Subscriber) {\n    if (callback) {\n      this.subscribers.add(callback);\n    }\n  }\n\n  unsubscribe(callback: Subscriber) {\n    this.subscribers.delete(callback);\n  }\n\n  private notify() {\n    if (isBatching) {\n      this.subscribers.forEach(callback => pendingSubscribers.add(callback));\n    } else {\n      this.notifying = true;\n      this.subscribers.forEach(callback => {\n        // @ts-ignore\n        if (!callback.done) {\n          // @ts-ignore\n          callback.done = true;\n          callback();\n        }\n      });\n      this.notifying = false;\n    }\n  }\n\n  addDependency(dep: Signal<any> | Computed<any>) {\n    this.dependencies.add(dep);\n    // 订阅重新计算\n    dep.subscribe(this.recompute);\n    // @ts-ignore\n    this.recompute.computedInstance = this;\n  }\n}\n\nexport class Effect {\n  private effectFn: () => void;\n  private dependencies: Set<Signal<any> | Computed<any>> = new Set();\n  private disposed = false;\n\n  constructor(effectFn: () => void) {\n    this.effectFn = effectFn;\n    this.run();\n  }\n\n  run = () => {\n    if (this.disposed) return;\n    const previousEffect = activeEffect;\n    activeEffect = this;\n    this.effectFn();\n    activeEffect = previousEffect;\n  }\n\n  addDependency(dep: Signal<any> | Computed<any>) {\n    if (this.disposed) return;\n    this.dependencies.add(dep);\n    // @ts-ignore\n    this.run.effectInstance = this;\n    dep.subscribe(this.run);\n  }\n\n  private cleanup() {\n    this.dependencies.forEach(dep => dep.unsubscribe(this.run));\n    this.dependencies.clear();\n  }\n\n  dispose() {\n    this.cleanup();\n    this.disposed = true;\n  }\n}\n\n// Factory functions\nexport function signal<T>(value: T): Signal<T> {\n  return new Signal(value);\n}\n\nexport function computed<T>(computeFn: () => T): Computed<T> {\n  return new Computed(computeFn);\n}\n\nexport function effect(effectFn: () => void): () => void {\n  const eff = new Effect(effectFn);\n  return () => eff.dispose();\n}\n\nexport function batch(fn: () => void) {\n  isBatching = true;\n  try {\n    fn();\n  } finally {\n    isBatching = false;\n    pendingSubscribers.forEach(callback => {\n      // @ts-ignore\n      if (!callback.done) {\n        // @ts-ignore\n        callback.done = true;\n        callback();\n      }\n    });\n    pendingSubscribers.forEach(callback => {\n      // @ts-ignore\n      callback.done = false;\n    });\n    pendingSubscribers.clear();\n  }\n}\n\nexport type SignalObject<T> = {\n  [K in keyof T]: Signal<T[K]>\n}\n\nexport function signalObject<T>(initialValues: T): SignalObject<T> {\n  const signals = Object.entries(initialValues as object).reduce(\n    (acc, [key, value]) => {\n      acc[key] = signal<T[keyof T]>(value as T[keyof T])\n      return acc\n    },\n    {} as { [key: string]: Signal<T[keyof T]> },\n  )\n\n  return signals as SignalObject<T>\n}\n"],"names":["activeEffect","isBatching","pendingSubscribers","Set","activeComponent","setActiveComponent","component","updateFnName","_tempActiveUpdateFnName","clearActiveComponent","getActiveComponent","Signal","constructor","value","this","_value","subscribers","depsComponents","notifying","run","subscribe","addDependency","add","newValue","update","peek","notify","forEach","_component$component$","call","callback","computedInstance","done","unsubscribe","delete","Computed","computeFn","dependencies","recompute","compute","_component$component$2","previousEffect","dep","Effect","effectFn","disposed","effectInstance","cleanup","clear","dispose","signal","computed","effect","eff","batch","fn","signalObject","initialValues","Object","entries","reduce","acc","key"],"mappings":"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"}
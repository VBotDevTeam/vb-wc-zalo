{"version":3,"file":"index.module.js","sources":["../src/reactivity.ts"],"sourcesContent":["type Subscriber = () => void;\n\nlet activeEffect: Effect | null = null;\nlet isBatching = false;\nlet pendingSubscribers: Set<Subscriber> = new Set();\n\nexport interface Component {\n  queuedUpdate: () => void\n  [key: string]: any\n  _tempActiveUpdateFnName?: string\n}\n\nlet activeComponent: Component | null = null\n\nexport function setActiveComponent(\n  component: Component,\n  updateFnName?: string,\n): void {\n  activeComponent = component\n  activeComponent._tempActiveUpdateFnName = updateFnName || 'queuedUpdate'\n}\n\nexport function clearActiveComponent(): void {\n  activeComponent = null\n}\n\nexport function getActiveComponent(): Component | null {\n  return activeComponent\n}\n\n\nexport class Signal<T> {\n  private _value: T;\n  private subscribers: Set<Subscriber> = new Set();\n  depsComponents = new Set<Component>()\n  constructor(value: T) {\n    this._value = value;\n  }\n\n  get value(): T {\n    // 没有在通知，才能添加依赖，否则会导致循环依赖\n    if (!this.notifying) {\n      if (activeEffect) {\n        // computed 内部触发的原始信号的 get value 不用加入原始信号的订阅\n        if (activeEffect.run) {\n          this.subscribe(activeEffect.run);\n        }\n        activeEffect.addDependency(this);\n      }\n    }\n\n    const component = getActiveComponent()\n    if (component) this.depsComponents.add(component)\n    return this._value;\n  }\n\n  set value(newValue: T) {\n    // 修改前也有 hook？\n    if (newValue !== this._value) {\n      this._value = newValue;\n      this.update();\n    }\n  }\n\n  peek() {\n    return this._value;\n  }\n\n  update() {\n    this.notify();\n    this.depsComponents.forEach(\n      (component) => component[component._tempActiveUpdateFnName!]?.(),\n    )\n    // 信号值修改后 hook，重置已经执行的 effect\n    this.subscribers.forEach(callback => {\n      // 重置计算属性的 subscribers，防止不依赖 signal 但依赖 computed的 effect不执行\n      // @ts-ignore\n      if (callback.computedInstance) {\n        // @ts-ignore\n        callback.computedInstance.subscribers.forEach(callback => {\n          callback.done = false;\n        });\n      }\n      // @ts-ignore\n      callback.done = false;\n    });\n  }\n\n  subscribe(callback: Subscriber) {\n    this.subscribers.add(callback);\n  }\n\n  unsubscribe(callback: Subscriber) {\n    this.subscribers.delete(callback);\n  }\n\n  private notifying = false;\n  private notify() {\n    if (isBatching) {\n      this.subscribers.forEach(callback => pendingSubscribers.add(callback));\n    } else {\n      this.notifying = true;\n      this.subscribers.forEach(callback => {\n        // @ts-ignore\n        if (typeof callback === 'function' && !callback.done) {\n          // @ts-ignore\n          callback.done = true;\n          callback();\n        }\n      });\n      this.notifying = false;\n    }\n  }\n}\n\nexport class Computed<T> {\n  private computeFn: () => T;\n  private _value: T;\n  private dependencies: Set<Signal<any> | Computed<any>> = new Set();\n  private subscribers: Set<Subscriber> = new Set();\n\n  depsComponents = new Set<Component>()\n\n  constructor(computeFn: () => T) {\n    this.computeFn = computeFn;\n    this._value = this.compute();\n  }\n\n  get value(): T {\n    if (!this.notifying) {\n      if (activeEffect) {\n        this.subscribe(activeEffect.run);\n        activeEffect.addDependency(this);\n      }\n    }\n    const component = getActiveComponent()\n    if (component) this.depsComponents.add(component)\n    return this._value;\n  }\n\n  peek() {\n    return this._value;\n  }\n\n  private notifying = false;\n  private compute(): T {\n\n    const previousEffect = activeEffect;\n    // @ts-ignore\n    activeEffect = this;\n    const newValue = this.computeFn();\n    activeEffect = previousEffect;\n\n    return newValue;\n  }\n\n  private recompute = () => {\n    const newValue = this.compute();\n    if (newValue !== this._value) {\n      this._value = newValue;\n      this.notify();\n      this.depsComponents.forEach(\n        (component) => component[component._tempActiveUpdateFnName!]?.(),\n      )\n    }\n  }\n\n  subscribe(callback: Subscriber) {\n    if (callback) {\n      this.subscribers.add(callback);\n    }\n  }\n\n  unsubscribe(callback: Subscriber) {\n    this.subscribers.delete(callback);\n  }\n\n  private notify() {\n    if (isBatching) {\n      this.subscribers.forEach(callback => pendingSubscribers.add(callback));\n    } else {\n      this.notifying = true;\n      this.subscribers.forEach(callback => {\n        // @ts-ignore\n        if (!callback.done) {\n          // @ts-ignore\n          callback.done = true;\n          callback();\n        }\n      });\n      this.notifying = false;\n    }\n  }\n\n  addDependency(dep: Signal<any> | Computed<any>) {\n    this.dependencies.add(dep);\n    // 订阅重新计算\n    dep.subscribe(this.recompute);\n    // @ts-ignore\n    this.recompute.computedInstance = this;\n  }\n}\n\nexport class Effect {\n  private effectFn: () => void;\n  private dependencies: Set<Signal<any> | Computed<any>> = new Set();\n  private disposed = false;\n\n  constructor(effectFn: () => void) {\n    this.effectFn = effectFn;\n    this.run();\n  }\n\n  run = () => {\n    if (this.disposed) return;\n    const previousEffect = activeEffect;\n    activeEffect = this;\n    this.effectFn();\n    activeEffect = previousEffect;\n  }\n\n  addDependency(dep: Signal<any> | Computed<any>) {\n    if (this.disposed) return;\n    this.dependencies.add(dep);\n    // @ts-ignore\n    this.run.effectInstance = this;\n    dep.subscribe(this.run);\n  }\n\n  private cleanup() {\n    this.dependencies.forEach(dep => dep.unsubscribe(this.run));\n    this.dependencies.clear();\n  }\n\n  dispose() {\n    this.cleanup();\n    this.disposed = true;\n  }\n}\n\n// Factory functions\nexport function signal<T>(value: T): Signal<T> {\n  return new Signal(value);\n}\n\nexport function computed<T>(computeFn: () => T): Computed<T> {\n  return new Computed(computeFn);\n}\n\nexport function effect(effectFn: () => void): () => void {\n  const eff = new Effect(effectFn);\n  return () => eff.dispose();\n}\n\nexport function batch(fn: () => void) {\n  isBatching = true;\n  try {\n    fn();\n  } finally {\n    isBatching = false;\n    pendingSubscribers.forEach(callback => {\n      // @ts-ignore\n      if (!callback.done) {\n        // @ts-ignore\n        callback.done = true;\n        callback();\n      }\n    });\n    pendingSubscribers.forEach(callback => {\n      // @ts-ignore\n      callback.done = false;\n    });\n    pendingSubscribers.clear();\n  }\n}\n\nexport type SignalObject<T> = {\n  [K in keyof T]: Signal<T[K]>\n}\n\nexport function signalObject<T>(initialValues: T): SignalObject<T> {\n  const signals = Object.entries(initialValues as object).reduce(\n    (acc, [key, value]) => {\n      acc[key] = signal<T[keyof T]>(value as T[keyof T])\n      return acc\n    },\n    {} as { [key: string]: Signal<T[keyof T]> },\n  )\n\n  return signals as SignalObject<T>\n}\n"],"names":["activeEffect","isBatching","pendingSubscribers","Set","activeComponent","setActiveComponent","component","updateFnName","_tempActiveUpdateFnName","clearActiveComponent","getActiveComponent","Signal","value","_value","subscribers","this","depsComponents","notifying","_proto","prototype","peek","update","notify","forEach","_component$component$","call","callback","computedInstance","done","subscribe","add","unsubscribe","_createClass","key","get","run","addDependency","set","newValue","Computed","computeFn","_this","dependencies","recompute","compute","_component$component$2","_proto2","previousEffect","dep","Effect","effectFn","_this2","disposed","_proto3","effectInstance","cleanup","_this3","clear","dispose","signal","computed","effect","eff","batch","fn","signalObject","initialValues","Object","entries","reduce","acc","_ref"],"mappings":"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"}